# 🛒 Оптимизация корзин - Документация

## 📋 Обзор

Данная документация описывает оптимизации, внедренные для улучшения производительности системы корзин при масштабировании.

## 🔍 Добавленные индексы

### Индексы для модели Order:
- `(user, status)` - для быстрого поиска корзины пользователя
- `(status, created_at)` - для очистки старых корзин
- `(user, status, created_at)` - композитный индекс для сложных запросов

### Индексы для модели OrderItem:
- `(order, product)` - для поиска товаров в заказе
- `(order)` - для получения всех товаров заказа

## 🧹 Команды очистки корзин

### 1. Просмотр статистики корзин
```bash
python manage.py cart_stats
```

**Опции:**
- `--days 30` - количество дней для анализа (по умолчанию: 30)
- `--notify` - отправить уведомление администратору если требуется очистка

**Пример вывода:**
```
📊 СТАТИСТИКА КОРЗИН И ЗАКАЗОВ (за последние 30 дней)
============================================================

📈 ОБЩАЯ СТАТИСТИКА:
  Всего заказов: 150
  Активных корзин: 45
  Всего товаров в заказах: 320
  Товаров в корзинах: 67

🏷️ СТАТИСТИКА ПО СТАТУСАМ:
  Корзина: 45 заказов (сумма: 0.00 ₽)
  Ожидает оплаты: 25 заказов (сумма: 45000.00 ₽)
  Оплачен: 80 заказов (сумма: 120000.00 ₽)

🗑️ СТАРЫЕ КОРЗИНЫ (старше 30 дней):
  Количество: 12
  Товаров в них: 23
  Средний возраст: 45 дней
```

### 2. Очистка старых корзин
```bash
python manage.py cleanup_old_carts
```

**Опции:**
- `--days 30` - количество дней, после которых корзины считаются старыми
- `--dry-run` - показать что будет удалено, без фактического удаления
- `--force` - принудительно удалить без подтверждения
- `--notify` - отправить уведомление администратору после очистки

**Примеры использования:**

```bash
# Предварительный просмотр (без удаления)
python manage.py cleanup_old_carts --dry-run

# Очистка корзин старше 7 дней с уведомлением
python manage.py cleanup_old_carts --days 7 --notify

# Принудительная очистка корзин старше 30 дней с уведомлением
python manage.py cleanup_old_carts --days 30 --force --notify
```

### 3. Отправка уведомлений о необходимости очистки
```bash
python manage.py notify_cleanup
```

**Опции:**
- `--force` - принудительно отправить уведомление даже если старых корзин нет
- `--threshold 30` - пороговое количество дней для уведомления (по умолчанию: 30)

**Примеры использования:**

```bash
# Проверить и отправить уведомление если нужно
python manage.py notify_cleanup

# Принудительно отправить уведомление
python manage.py notify_cleanup --force

# Проверить корзины старше 7 дней
python manage.py notify_cleanup --threshold 7
```

## 📧 Система уведомлений

### Типы уведомлений:

#### 1. Уведомление о необходимости очистки
- **Триггер:** Найдены старые корзины (>30 дней)
- **Уровни критичности:**
  - 🔴 **КРИТИЧЕСКИЙ** (>100 старых корзин)
  - 🟠 **ВЫСОКИЙ** (50-100 старых корзин)
  - 🟡 **СРЕДНИЙ** (<50 старых корзин)

#### 2. Уведомление о результатах очистки
- **Триггер:** После успешной очистки корзин
- **Содержит:** Статистику удаленных корзин и текущее состояние

### Примеры уведомлений:

#### Уведомление о необходимости очистки:
```
Тема: ⚠️ Требуется очистка корзин - КРИТИЧЕСКИЙ уровень

📊 Статистика корзин:
- Всего корзин: 150
- Товаров в корзинах: 320
- Старых корзин (>7 дней): 45
- Старых корзин (>30 дней): 120

🔧 Рекомендуемые действия:
1. Запустить очистку: python manage.py cleanup_old_carts --days 30 --force
2. Проверить статистику: python manage.py cart_stats --days 30
3. Настроить автоматическую очистку
```

#### Уведомление о результатах очистки:
```
Тема: ✅ Очистка корзин завершена - удалено 120 корзин

📊 Результаты очистки:
- Удалено корзин: 120
- Удалено товаров: 250
- Возраст корзин: старше 30 дней

📈 Текущая статистика:
- Всего корзин: 30
- Товаров в корзинах: 70
- Старых корзин (>30 дней): 0
```
